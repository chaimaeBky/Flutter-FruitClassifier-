<!DOCTYPE html>
<html>
<head>
  <base href="$FLUTTER_BASE_HREF">
  
  <meta charset="UTF-8">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="FruitAI - Intelligent Fruit Recognition App by Chaimae EL BAKAY">

  <!-- IMPORTANT: TensorFlow.js DOIT √™tre charg√© en premier -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
  
  <!-- Votre mod√®le TFLite personnalis√© -->
  <script src="tfjs_model.js"></script>

  <!-- iOS meta tags & icons -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="FruitAI">
  <link rel="apple-touch-icon" href="icons/Icon-192.png">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="favicon.png"/>

  <title>FruitAI | Chaimae EL BAKAY</title>
  
  <style>
    /* Reset and base styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: linear-gradient(135deg, #008080 0%, #006666 100%);
      color: white;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 20px;
      overflow: hidden;
    }
    
    .loading-screen {
      max-width: 800px;
      width: 100%;
      text-align: center;
      padding: 40px 20px;
      position: relative;
      z-index: 10;
    }
    
    .profile-container {
      width: 150px;
      height: 150px;
      margin: 0 auto 30px;
      border-radius: 50%;
      overflow: hidden;
      border: 3px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
    }
    
    .profile-pic {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .app-title {
      font-size: 42px;
      font-weight: 700;
      margin-bottom: 16px;
      letter-spacing: -0.5px;
    }
    
    .developer {
      font-size: 18px;
      opacity: 0.9;
      margin-bottom: 40px;
      font-weight: 300;
    }
    
    .features-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 30px;
      margin: 50px 0;
    }
    
    .feature-card {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(12px);
      border-radius: 16px;
      padding: 30px;
      border: 1px solid rgba(255, 255, 255, 0.15);
      transition: transform 0.3s ease, background 0.3s ease;
    }
    
    .feature-title {
      font-size: 22px;
      font-weight: 600;
      margin-bottom: 15px;
    }
    
    .feature-description {
      font-size: 16px;
      line-height: 1.6;
      opacity: 0.9;
    }
    
    .loading-indicator {
      margin-top: 50px;
    }
    
    .loading-text {
      font-size: 16px;
      opacity: 0.8;
      margin-bottom: 15px;
      min-height: 24px;
    }
    
    .progress-bar {
      width: 300px;
      height: 4px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 2px;
      margin: 0 auto;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background: white;
      width: 0%;
      border-radius: 2px;
      transition: width 0.5s ease;
    }
    
    /* Animations */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes fadeOut {
      from {
        opacity: 1;
        transform: scale(1);
      }
      to {
        opacity: 0;
        transform: scale(0.95);
      }
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 0.8; }
      50% { opacity: 1; }
    }
    
    .animate-fade-in {
      animation: fadeInUp 0.8s ease-out forwards;
    }
    
    .animate-fade-out {
      animation: fadeOut 1s ease-out forwards;
    }
    
    .animate-pulse {
      animation: pulse 2s infinite;
    }
    
    .delay-1 { animation-delay: 0.2s; opacity: 0; }
    .delay-2 { animation-delay: 0.4s; opacity: 0; }
    .delay-3 { animation-delay: 0.6s; opacity: 0; }
    
    /* Responsive */
    @media (max-width: 768px) {
      .app-title {
        font-size: 32px;
      }
      
      .features-container {
        grid-template-columns: 1fr;
        gap: 20px;
      }
      
      .feature-card {
        padding: 24px;
      }
      
      .profile-container {
        width: 120px;
        height: 120px;
      }
      
      .progress-bar {
        width: 250px;
      }
    }
  </style>
  
</head>
<body>
  <!-- Loading Screen -->
  <div class="loading-screen" id="loadingScreen">
    <div class="profile-container animate-fade-in">
      <img src="assets/images/profile.png" alt="Chaimae EL BAKAY" class="profile-pic">
    </div>
    
    <h1 class="app-title animate-fade-in delay-1">Fruit AI</h1>
    <div class="developer animate-fade-in delay-1">by Chaimae EL BAKAY</div>
    
    <div class="features-container">
      <div class="feature-card animate-fade-in delay-2">
        <h3 class="feature-title">Smart Fruit Recognition</h3>
        <p class="feature-description">
          Upload photos of fruits, and our AI will instantly identify them 
          with high accuracy.
        </p>
      </div>
      
      <div class="feature-card animate-fade-in delay-2">
        <h3 class="feature-title">AI Nutrition Assistant</h3>
        <p class="feature-description">
          Chat with our AI assistant to learn about nutritional values, health benefits...
        </p>
      </div>
    </div>
    
    <div class="loading-indicator animate-fade-in delay-3">
      <div class="loading-text animate-pulse" id="loadingText">Loading AI Models...</div>
      <div class="progress-bar">
        <div class="progress-fill" id="progressBar"></div>
      </div>
    </div>
  </div>

  <!-- Flutter container - hidden initially -->
  <div id="flutter-container" style="display: none; width: 100%; height: 100vh;"></div>
  
  <script>
    // Configuration
    const TOTAL_LOAD_TIME = 5000; // 5 seconds total (plus court)
    const PROGRESS_DURATION = 4000; // 4 seconds for progress bar
    const FADE_OUT_DURATION = 1000; // 1 second fade out
    
    // Elements
    const loadingScreen = document.getElementById('loadingScreen');
    const progressBar = document.getElementById('progressBar');
    const loadingText = document.getElementById('loadingText');
    const flutterContainer = document.getElementById('flutter-container');
    
    // Loading messages sp√©cifiques pour votre mod√®le AI
    const loadingMessages = [
      'Loading TensorFlow.js...',
      'Initializing TFLite Model...',
      'Preparing Fruit Classifier...',
      'Starting AI Assistant...',
      'Launching Fruit AI...'
    ];
    
    let currentMessageIndex = 0;
    let startTime;
    
    // Update loading message
    function updateLoadingMessage() {
      if (currentMessageIndex < loadingMessages.length) {
        loadingText.textContent = loadingMessages[currentMessageIndex];
        currentMessageIndex++;
        
        // Schedule next message update
        if (currentMessageIndex < loadingMessages.length) {
          setTimeout(updateLoadingMessage, PROGRESS_DURATION / loadingMessages.length);
        }
      }
    }
    
    // Animate progress bar
    function animateProgressBar() {
      let progress = 0;
      const interval = 50; // Update every 50ms
      const increment = (100 / (PROGRESS_DURATION / interval));
      
      const progressInterval = setInterval(() => {
        progress += increment;
        progressBar.style.width = Math.min(progress, 100) + '%';
        
        if (progress >= 100) {
          clearInterval(progressInterval);
        }
      }, interval);
    }
    
    // V√©rifier que TensorFlow.js est charg√©
    function checkTensorFlowLoaded() {
      if (typeof tf !== 'undefined') {
        console.log('‚úÖ TensorFlow.js loaded');
        
        // V√©rifier si votre mod√®le TFLite est charg√©
        if (typeof tfjsModel !== 'undefined') {
          console.log('‚úÖ TFLite Model script loaded');
          return true;
        } else {
          console.warn('‚ö†Ô∏è tfjsModel not found');
          return false;
        }
      } else {
        console.error('‚ùå TensorFlow.js not loaded');
        return false;
      }
    }
    
    // Start Flutter loading
    function startFlutterLoad() {
      console.log('üöÄ Starting Flutter load...');
      
      // V√©rifier que TensorFlow.js et votre mod√®le sont charg√©s
      if (!checkTensorFlowLoaded()) {
        console.warn('AI models not fully loaded, continuing anyway...');
      }
      
      // Cr√©er et charger le script Flutter
      const script = document.createElement('script');
      script.src = 'main.dart.js';
      script.type = 'application/javascript';
      script.async = true;
      
      script.onload = function() {
        console.log('‚úÖ Flutter script loaded successfully');
        
        // D√©marrer l'application Flutter
        if (typeof _flutter !== 'undefined' && _flutter.loader) {
          _flutter.loader.loadEntrypoint({
            serviceWorker: {
              serviceWorkerVersion: serviceWorkerVersion,
            }
          }).then(function(engineInitializer) {
            return engineInitializer.initializeEngine();
          }).then(function(appRunner) {
            return appRunner.runApp();
          }).then(function() {
            console.log('üéâ Flutter app running successfully');
          }).catch(function(error) {
            console.error('Flutter initialization error:', error);
            loadingText.textContent = 'Application ready!';
          });
        } else {
          console.error('Flutter loader not found');
          loadingText.textContent = 'Click to start';
        }
      };
      
      script.onerror = function(error) {
        console.error('Failed to load Flutter:', error);
        loadingText.textContent = 'Error loading app. Please refresh.';
        loadingText.style.color = '#ff6b6b';
      };
      
      document.head.appendChild(script);
    }
    
    // Fade out loading screen and show Flutter
    function transitionToFlutter() {
      console.log('üîÑ Transitioning to Flutter...');
      
      // V√©rifier l'√©tat du mod√®le AI
      const aiReady = checkTensorFlowLoaded();
      loadingText.textContent = aiReady 
        ? 'AI Models Ready! Launching App...' 
        : 'Launching App...';
      
      // Add fade out animation
      loadingScreen.classList.add('animate-fade-out');
      
      // Wait for fade out to complete
      setTimeout(() => {
        // Hide loading screen
        loadingScreen.style.display = 'none';
        
        // Show Flutter container
        flutterContainer.style.display = 'block';
        
        // Start loading Flutter
        startFlutterLoad();
        
        console.log('üì± Flutter container visible');
      }, FADE_OUT_DURATION);
    }
    
    // Initialize everything
    function init() {
      console.log('üé¨ Initializing splash screen...');
      startTime = Date.now();
      
      // Start progress animation
      animateProgressBar();
      
      // Start updating messages
      updateLoadingMessage();
      
      // V√©rifier rapidement le chargement
      setTimeout(() => {
        const aiStatus = checkTensorFlowLoaded();
        console.log('AI Load Status:', aiStatus ? 'Ready' : 'Not Ready');
      }, 1000);
      
      // Schedule transition to Flutter
      setTimeout(() => {
        console.log('‚è∞ Time reached, transitioning...');
        transitionToFlutter();
      }, TOTAL_LOAD_TIME);
      
      // Fallback: If Flutter container becomes visible sooner, hide loading
      const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
            const style = flutterContainer.getAttribute('style');
            if (style && style.includes('display: block') && loadingScreen.style.display !== 'none') {
              console.log('Flutter container detected, hiding loading screen');
              loadingScreen.style.display = 'none';
            }
          }
        });
      });
      
      observer.observe(flutterContainer, { attributes: true });
    }
    
    // Start when page loads
    window.addEventListener('DOMContentLoaded', init);
    
    // Handle profile picture load error
    window.addEventListener('load', function() {
      const profilePic = document.querySelector('.profile-pic');
      if (profilePic && profilePic.naturalWidth === 0) {
        // Use a simple fruit icon as fallback
        profilePic.style.objectFit = 'contain';
        profilePic.style.padding = '20px';
        profilePic.style.backgroundColor = 'rgba(255, 255, 255, 0.1)';
      }
    });
  </script>
</body>
</html>